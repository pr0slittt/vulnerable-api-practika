# semgrep-rules/info-disclosure-tokens-get.yaml
rules:
  - id: information-disclosure-tokens-get
    message: |
      GET-метод для эндпоинта /tokens возвращает все данные пользователей, включая пароли.
      Этот маршрут не задокументирован и является серьезной утечкой информации.
    severity: ERROR
    languages:
      - python
    patterns:
      # Главный паттерн, ищущий функцию маршрута /tokens с методом GET
      - pattern: |
          @route("/tokens", method="GET")
          def $FUNC_NAME():
            $SETUP_CODE
            $DB_CURSOR.execute($SQL_QUERY)
            $FETCHED_DATA = $DB_CURSOR.$FETCH_METHOD()
            $RETURN_STATEMENT
            $TEARDOWN_CODE

      # Отдельное определение для метапеременной $SQL_QUERY
      - metavariable-pattern:
          metavariable: $SQL_QUERY
          pattern-regex: 'SELECT\s+.*?\s+FROM\s+users'

      # Отдельное определение для метапеременной $FETCH_METHOD
      - metavariable-pattern:
          metavariable: $FETCH_METHOD
          pattern-either:
            - pattern: fetchall()
            - pattern: fetchone()

      # Отдельное определение для метапеременной $RETURN_STATEMENT
      - metavariable-pattern:
          metavariable: $RETURN_STATEMENT
          pattern-either:
            - pattern: 'return $FETCHED_DATA' # Возврат напрямую
            - pattern: 'return {"response": $FETCHED_DATA}' # Возврат в словаре с ключом "response"
            - pattern: 'return {"$KEY": $FETCHED_DATA}' # Возврат в словаре с любым ключом

    paths:
      include:
        - vAPI.py
