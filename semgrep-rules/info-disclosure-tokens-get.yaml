# semgrep-rules/info-disclosure-tokens-get.yaml
rules:
  - id: information-disclosure-tokens-get
    message: |
      GET-метод для эндпоинта /tokens возвращает все данные пользователей, включая пароли.
      Этот маршрут не задокументирован и является серьезной утечкой информации.
    severity: ERROR
    languages:
      - python
    patterns:
      - pattern-inside: |
          @route("/tokens", method="GET")
          def get_get_token():
            ...
            c.execute("SELECT $ANY_COLUMNS FROM users") # Ищем выборку из таблицы users
            $USERS_DATA = c.fetchall() # Результат fetchall()
            return {"response": $USERS_DATA} # Возврат данных в ответе
      # Убеждаемся, что переменная $USERS_DATA действительно содержит результат c.fetchall()
      - metavariable-pattern:
          metavariable: $USERS_DATA
          pattern: |
            $SOME_VAR = c.fetchall()
    paths:
      include:
        - vAPI.py
