# semgrep-rules/info-disclosure-tokens-get.yaml
rules:
  - id: information-disclosure-tokens-get
    message: |
      GET-метод для эндпоинта /tokens возвращает все данные пользователей, включая пароли.
      Этот маршрут не задокументирован и является серьезной утечкой информации.
    severity: ERROR
    languages:
      - python
    patterns:
      # 1. Найти маршрут "/tokens" с методом GET
      - pattern-inside: |
          @route("/tokens", method="GET")
          def $FUNC_NAME():
            ...

      # 2. Внутри этой функции найти выполнение SQL-запроса, который выбирает данные из таблицы "users"
      - pattern-inside: |
          def $FUNC_NAME():
            ...
            $DB_CURSOR.execute("SELECT $COLUMNS FROM users $WHERE_CLAUSE")
            ...

      # 3. Внутри этой же функции найти вызов fetchall() или fetchone()
      #    и присвоение результата в метапеременную $FETCHED_DATA.
      - pattern-inside: |
          def $FUNC_NAME():
            ...
            $FETCHED_DATA = $FETCH_METHOD()
            ...
      - metavariable-pattern:
          metavariable: $FETCH_METHOD
          pattern-either:
            - pattern: $DB_CURSOR.fetchall()
            - pattern: $DB_CURSOR.fetchone()

      # 4. Внутри этой же функции найти возвращаемое значение, которое включает $FETCHED_DATA.
      - pattern-inside: |
          def $FUNC_NAME():
            ...
            return $RETURN_VALUE
      - metavariable-pattern:
          metavariable: $RETURN_VALUE
          pattern-either:
            - pattern: $FETCHED_DATA # Возврат напрямую
            - pattern: {"response": $FETCHED_DATA} # Возврат в словаре с ключом "response"
            - pattern: {"$KEY": $FETCHED_DATA} # Возврат в словаре с любым ключом
    paths:
      include:
        - vAPI.py
