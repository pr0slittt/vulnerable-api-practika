# semgrep-rules/token-expiration-check.yaml
rules:
  - id: token-expiration-check-missing
    message: |
      Токены аутентификации используются без адекватной проверки срока их действия во всех точках использования.
      Это позволяет злоумышленникам использовать просроченные токены для доступа к ресурсам.
    severity: WARNING
    languages:
      - python
    patterns:
      # Проверяем эндпоинт GET /user/<user_id>
      - patterns:
          - pattern-inside: |
              @route("/user/<user_id>", method="GET")
              def get_user(user_id):
                ...
                token_record = c.fetchone()
                if isinstance(token_record, tuple) and token_record[1] == str($TOKEN):
                  ...
          # Убеждаемся, что внутри этого блока НЕ ПРИСУТСТВУЕТ проверка срока действия токена
          - pattern-not: |
              $TOKEN_RECORD[3] >= int(time.time())
      # Проверяем эндпоинт POST /user (для создания)
      - patterns:
          - pattern-inside: |
              @route("/user", method="POST")
              def create_user():
                ...
                token_record = c.fetchone()
                # Добавлено условие проверки токена, если оно присутствует в вашем коде
                if isinstance(token_record, tuple) and token_record[1] == str($TOKEN):
                  ...
          - pattern-not: |
              $TOKEN_RECORD[3] >= int(time.time())
      # Проверяем эндпоинт DELETE /user/<user_id>
      - patterns:
          - pattern-inside: |
              @route("/user/<user_id>", method="DELETE")
              def delete_user_by_id(user_id):
                ...
                token_record = c.fetchone()
                if isinstance(token_record, tuple) and token_record[1] == str($TOKEN):
                  ...
          - pattern-not: |
              $TOKEN_RECORD[3] >= int(time.time())
    paths:
      include:
        - vAPI.py
