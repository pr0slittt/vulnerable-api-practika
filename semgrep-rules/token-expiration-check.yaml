# semgrep-rules/token-expiration-check.yaml
rules:
  - id: token-expiration-check-missing
    message: |
      Токены аутентификации используются без адекватной проверки срока их действия во всех точках использования.
      Это позволяет злоумышленникам использовать просроченные токены для доступа к ресурсам.
    severity: WARNING
    languages:
      - python
    patterns:
      - pattern-either: # Проверяем эндпоинты, которые должны проверять токен
          - pattern: |
              @route("/user/<user_id>", method="GET")
              def get_user(user_id):
                ...
                token_record = c.fetchone()
                if isinstance(token_record, tuple) and token_record[1] == str($TOKEN):
                  # Отсутствует проверка: token_record[3] < int(time.time())
                  ...
                  $QUERY_EXECUTION
          - pattern: |
              @route("/user", method="POST")
              def create_user():
                ...
                token_record = c.fetchone()
                if isinstance(token_record, tuple):
                  # Отсутствует проверка: token_record[3] < int(time.time())
                  ...
                  $QUERY_EXECUTION
          - pattern: |
              @route("/user/<user_id>", method="DELETE")
              def delete_user_by_id(user_id):
                ...
                token_record = c.fetchone()
                if isinstance(token_record, tuple) and token_record[1] == str($TOKEN):
                  # Отсутствует проверка: token_record[3] < int(time.time())
                  ...
                  $QUERY_EXECUTION
    # Исключаем конкретно эндпоинт /tokens POST, так как там есть логика работы со сроком действия,
    # и мы сфокусированы на отсутствии проверки в других местах, где токен используется.
    paths:
      include:
        - vAPI.py
      exclude:
        - vAPI.py:tokens.py # Исключаем файл, если он существовал бы отдельно
